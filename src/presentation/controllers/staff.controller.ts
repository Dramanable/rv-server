/**
 * üë• STAFF CONTROLLER
 * ‚úÖ REST API pour la gesti@A@Ap@ApiTags('üë®‚Äçüíº Staff Management')
@Controller('staff')
@ApiBearerAuth()
export class StaffController {('üë®‚Äçüíº Staff Management')
@Controller('staff')
@ApiBearerAuth()
export class StaffController {s('üë®‚Äçüíº Staff Management')
@Controller('staff')
@ApiBearerAuth()u personnel
 * ‚úÖ CRUD complet + recherche avanc√©e
 * ‚úÖ Pattern standardis√© conforme au projet
 */

import {
  Body,
  Controller,
  Delete,
  Get,
  HttpCode,
  HttpStatus,
  Inject,
  Param,
  Post,
  Put,
} from '@nestjs/common';
import {
  ApiBearerAuth,
  ApiOperation,
  ApiParam,
  ApiResponse,
  ApiTags,
} from '@nestjs/swagger';

import { APPLICATION_TOKENS, TOKENS } from '@shared/constants/injection-tokens';
import { User } from '../../domain/entities/user.entity';
import { GetUser } from '../security/decorators/get-user.decorator';

import { CreateStaffUseCase } from '../../application/use-cases/staff/create-staff.use-case';
import { DeleteStaffUseCase } from '../../application/use-cases/staff/delete-staff.use-case';
import { GetStaffUseCase } from '../../application/use-cases/staff/get-staff.use-case';
import { ListStaffUseCase } from '../../application/use-cases/staff/list-staff.use-case';
import { UpdateStaffUseCase } from '../../application/use-cases/staff/update-staff.use-case';

// ‚úÖ NOUVEAUX USE CASES - Staff Availability Management
import { GetAvailableStaffUseCase } from '../../application/use-cases/staff/get-available-staff.use-case';
import { GetStaffAvailabilityUseCase } from '../../application/use-cases/staff/get-staff-availability.use-case';
import { SetStaffAvailabilityUseCase } from '../../application/use-cases/staff/set-staff-availability.use-case';

import { StaffStatus } from '../../domain/entities/staff.entity';
import {
  CloudProvider,
  FileUrl,
} from '../../domain/value-objects/file-url.value-object';
import {
  CreateStaffDto,
  CreateStaffResponseDto,
  DeleteStaffResponseDto,
  GetStaffResponseDto,
  ListStaffDto,
  ListStaffResponseDto,
  UpdateStaffDto,
  UpdateStaffResponseDto,
} from '../dtos/staff.dto';

@ApiTags('ÔøΩ‚Äçüíº Staff Management')
@Controller('staff')
@ApiBearerAuth()
export class StaffController {
  constructor(
    @Inject(TOKENS.CREATE_STAFF_USE_CASE)
    private readonly createStaffUseCase: CreateStaffUseCase,
    @Inject(TOKENS.GET_STAFF_USE_CASE)
    private readonly getStaffUseCase: GetStaffUseCase,
    @Inject(TOKENS.LIST_STAFF_USE_CASE)
    private readonly listStaffUseCase: ListStaffUseCase,
    @Inject(TOKENS.UPDATE_STAFF_USE_CASE)
    private readonly updateStaffUseCase: UpdateStaffUseCase,
    @Inject(TOKENS.DELETE_STAFF_USE_CASE)
    private readonly deleteStaffUseCase: DeleteStaffUseCase,

    // ‚úÖ NOUVEAUX USE CASES - Staff Availability Management
    @Inject(APPLICATION_TOKENS.SET_STAFF_AVAILABILITY_USE_CASE)
    private readonly setStaffAvailabilityUseCase: SetStaffAvailabilityUseCase,
    @Inject(APPLICATION_TOKENS.GET_STAFF_AVAILABILITY_USE_CASE)
    private readonly getStaffAvailabilityUseCase: GetStaffAvailabilityUseCase,
    @Inject(APPLICATION_TOKENS.GET_AVAILABLE_STAFF_USE_CASE)
    private readonly getAvailableStaffUseCase: GetAvailableStaffUseCase,
  ) {}

  /**
   * üìã LIST STAFF - Pattern standardis√©
   * Liste pagin√©e avec recherche et filtres avanc√©s
   */
  @Post('list')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({
    summary: 'üìã List staff with advanced search and pagination',
    description: `
    Liste pagin√©e du personnel avec recherche avanc√©e et filtres.

    ‚úÖ Fonctionnalit√©s :
    - Recherche textuelle (nom, email, sp√©cialisation)
    - Filtrage par r√¥le, statut, entreprise
    - Tri par multiple crit√®res
    - Pagination avanc√©e avec m√©tadonn√©es
    - Support des permissions par r√¥le

    üìä M√©tadonn√©es incluses :
    - Statistiques de pagination compl√®tes
    - Compteurs par statut et r√¥le
    - Indicateurs de performance
    `,
  })
  @ApiResponse({
    status: HttpStatus.OK,
    description: '‚úÖ Staff list retrieved successfully',
    type: ListStaffResponseDto,
  })
  @ApiResponse({
    status: HttpStatus.BAD_REQUEST,
    description: '‚ùå Invalid search parameters',
  })
  @ApiResponse({
    status: HttpStatus.UNAUTHORIZED,
    description: 'üîê Authentication required',
  })
  @ApiResponse({
    status: HttpStatus.FORBIDDEN,
    description: 'üö´ Insufficient permissions',
  })
  async list(
    @Body() dto: ListStaffDto,
    @GetUser() user: User,
  ): Promise<ListStaffResponseDto> {
    const response = await this.listStaffUseCase.execute({
      requestingUserId: user.id,
      pagination: {
        page: dto.page || 1,
        limit: dto.limit || 10,
      },
      sorting: {
        sortBy: dto.sortBy || 'createdAt',
        sortOrder: dto.sortOrder || 'desc',
      },
      filters: {
        search: dto.search,
        role: dto.role,
        isActive: dto.isActive,
        businessId: dto.businessId,
      },
    });

    return {
      success: true,
      data: response.data,
      meta: response.meta,
    };
  }

  /**
   * üìÑ GET STAFF BY ID
   * R√©cup√®re les d√©tails complets d'un membre du personnel
   */
  @Get(':id')
  @ApiOperation({
    summary: 'üìÑ Get staff member by ID',
    description: `
    R√©cup√®re les informations compl√®tes d'un membre du personnel.

    ‚úÖ Informations retourn√©es :
    - Profil complet (nom, titre, sp√©cialisation)
    - Horaires de travail et disponibilit√©s
    - R√¥le et permissions
    - Statistiques de performance
    - Int√©gration calendaire
    - Informations de contact
    `,
  })
  @ApiParam({
    name: 'id',
    description: 'Staff member UUID',
    example: '123e4567-e89b-12d3-a456-426614174000',
  })
  @ApiResponse({
    status: HttpStatus.OK,
    description: '‚úÖ Staff member retrieved successfully',
    type: GetStaffResponseDto,
  })
  @ApiResponse({
    status: HttpStatus.NOT_FOUND,
    description: '‚ùå Staff member not found',
  })
  @ApiResponse({
    status: HttpStatus.UNAUTHORIZED,
    description: 'üîê Authentication required',
  })
  @ApiResponse({
    status: HttpStatus.FORBIDDEN,
    description: 'üö´ Insufficient permissions',
  })
  async findById(
    @Param('id') id: string,
    @GetUser() user: User,
  ): Promise<GetStaffResponseDto> {
    const response = await this.getStaffUseCase.execute({
      staffId: id,
      requestingUserId: user.id,
    });

    return {
      success: true,
      data: response,
      meta: {
        timestamp: new Date().toISOString(),
        requestId: `staff-${Date.now()}`,
      },
    };
  }

  /**
   * ‚ûï CREATE STAFF
   * Cr√©√© un nouveau membre du personnel
   */
  @Post()
  @HttpCode(HttpStatus.CREATED)
  @ApiOperation({
    summary: '‚ûï Create new staff member',
    description: `
    Cr√©√© un nouveau membre du personnel avec profil complet.

    ‚úÖ Fonctionnalit√©s :
    - Validation des donn√©es compl√®te
    - V√©rification des permissions
    - Int√©gration automatique au calendrier
    - Configuration des horaires de travail
    - Notification aux parties prenantes
    - G√©neration automatique des acc√®s

    üìù Donn√©es requises :
    - Informations personnelles de base
    - R√¥le et permissions
    - Entreprise d'affectation
    - Sp√©cialisation et certifications
    - Horaires de travail par d√©faut
    `,
  })
  @ApiResponse({
    status: HttpStatus.CREATED,
    description: '‚úÖ Staff member created successfully',
    type: CreateStaffResponseDto,
  })
  @ApiResponse({
    status: HttpStatus.BAD_REQUEST,
    description: '‚ùå Invalid staff data',
  })
  @ApiResponse({
    status: HttpStatus.CONFLICT,
    description: '‚ö†Ô∏è Staff member already exists',
  })
  @ApiResponse({
    status: HttpStatus.UNAUTHORIZED,
    description: 'üîê Authentication required',
  })
  @ApiResponse({
    status: HttpStatus.FORBIDDEN,
    description: 'üö´ Insufficient permissions',
  })
  async create(
    @Body() dto: CreateStaffDto,
    @GetUser() user: User,
  ): Promise<CreateStaffResponseDto> {
    const response = await this.createStaffUseCase.execute({
      businessId: dto.businessId,
      firstName: dto.firstName,
      lastName: dto.lastName,
      email: dto.email,
      phone: dto.phone,
      role: dto.role,
      jobTitle: dto.jobTitle,
      workingHours: dto.workingHours,
      requestingUserId: user.id,
    });

    return {
      success: true,
      data: {
        id: response.id,
        firstName: response.firstName,
        lastName: response.lastName,
        email: response.email,
        role: response.role,
        businessId: response.businessId,
        isActive: response.isActive,
        createdAt: response.createdAt,
      },
      meta: {
        timestamp: new Date().toISOString(),
        requestId: `create-staff-${Date.now()}`,
      },
    };
  }

  /**
   * ‚úèÔ∏è UPDATE STAFF
   * Met √† jour les informations d'un membre du personnel
   */
  @Put(':id')
  @ApiOperation({
    summary: '‚úèÔ∏è Update staff member',
    description: `
    Met √† jour les informations d'un membre du personnel.

    ‚úÖ Donn√©es modifiables :
    - Profil personnel (nom, titre, bio)
    - Sp√©cialisation et certifications
    - R√¥le et permissions (avec validation)
    - Horaires de travail
    - Informations de contact
    - Statut (actif/inactif)
    - Int√©gration calendaire

    üîê R√®gles de s√©curit√© :
    - V√©rification des permissions appropri√©es
    - Validation des modifications de r√¥le
    - Audit trail complet des changements
    - Notification des changements critiques
    `,
  })
  @ApiParam({
    name: 'id',
    description: 'Staff member UUID',
    example: '123e4567-e89b-12d3-a456-426614174000',
  })
  @ApiResponse({
    status: HttpStatus.OK,
    description: '‚úÖ Staff member updated successfully',
    type: UpdateStaffResponseDto,
  })
  @ApiResponse({
    status: HttpStatus.BAD_REQUEST,
    description: '‚ùå Invalid update data',
  })
  @ApiResponse({
    status: HttpStatus.NOT_FOUND,
    description: '‚ùå Staff member not found',
  })
  @ApiResponse({
    status: HttpStatus.UNAUTHORIZED,
    description: 'üîê Authentication required',
  })
  @ApiResponse({
    status: HttpStatus.FORBIDDEN,
    description: 'üö´ Insufficient permissions',
  })
  async update(
    @Param('id') id: string,
    @Body() dto: UpdateStaffDto,
    @GetUser() user: User,
  ): Promise<UpdateStaffResponseDto> {
    const response = await this.updateStaffUseCase.execute({
      staffId: id,
      requestingUserId: user.id,
      updates: {
        profile: dto.profile
          ? {
              firstName: dto.profile.firstName,
              lastName: dto.profile.lastName,
              title: dto.profile.title,
              specialization: dto.profile.specialization,
              bio: dto.profile.bio,
              profileImageUrl: dto.profile.profileImageUrl
                ? new FileUrl(
                    dto.profile.profileImageUrl,
                    CloudProvider.AWS_S3,
                    'staff-profiles',
                    `staff-${Date.now()}`,
                  )
                : undefined,
              certifications: dto.profile.certifications,
              languages: dto.profile.languages,
            }
          : undefined,
        email: dto.contactInfo?.email,
        status: dto.status ? (dto.status as StaffStatus) : undefined,
        availability: dto.availability,
      },
    });

    return {
      success: true,
      data: response,
      meta: {
        timestamp: new Date().toISOString(),
        requestId: `update-staff-${Date.now()}`,
      },
    };
  }

  /**
   * üóëÔ∏è DELETE STAFF
   * Supprime un membre du personnel (avec v√©rifications)
   */
  @Delete(':id')
  @ApiOperation({
    summary: 'üóëÔ∏è Delete staff member',
    description: `
    Supprime un membre du personnel avec toutes les v√©rifications n√©cessaires.

    ‚ö†Ô∏è V√©rifications avant suppression :
    - Validation des permissions appropri√©es
    - V√©rification des rendez-vous en cours
    - Gestion des rendez-vous futurs
    - R√©assignation si n√©cessaire
    - Archivage des donn√©es historiques

    üîí R√®gles de s√©curit√© :
    - Seuls les administrateurs peuvent supprimer
    - Audit trail complet de la suppression
    - Confirmation requise pour suppression d√©finitive
    - Possibilit√© de d√©sactivation plut√¥t que suppression
    `,
  })
  @ApiParam({
    name: 'id',
    description: 'Staff member UUID',
    example: '123e4567-e89b-12d3-a456-426614174000',
  })
  @ApiResponse({
    status: HttpStatus.OK,
    description: '‚úÖ Staff member deleted successfully',
    type: DeleteStaffResponseDto,
  })
  @ApiResponse({
    status: HttpStatus.NOT_FOUND,
    description: '‚ùå Staff member not found',
  })
  @ApiResponse({
    status: HttpStatus.CONFLICT,
    description: '‚ö†Ô∏è Cannot delete staff with active appointments',
  })
  @ApiResponse({
    status: HttpStatus.UNAUTHORIZED,
    description: 'üîê Authentication required',
  })
  @ApiResponse({
    status: HttpStatus.FORBIDDEN,
    description: 'üö´ Insufficient permissions - Admin required',
  })
  async delete(
    @Param('id') id: string,
    @GetUser() user: User,
  ): Promise<DeleteStaffResponseDto> {
    const response = await this.deleteStaffUseCase.execute({
      staffId: id,
      requestingUserId: user.id,
    });

    return {
      success: response.success,
      data: {
        staffId: response.staffId,
        message: response.message,
      },
      meta: {
        timestamp: new Date().toISOString(),
        requestId: `delete-staff-${Date.now()}`,
      },
    };
  }

  /**
   * üöÄ DISPONIBILIT√âS DES STAFF - NOUVELLE FONCTIONNALIT√â BUSINESS
   * ‚úÖ Endpoints selon workflow Copilot (Domain ‚Üí Application ‚Üí Infrastructure ‚Üí Presentation)
   */

  @Post(':id/availability')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({
    summary: 'üìÖ D√©finir les disponibilit√©s du staff',
    description: `
    **Configure les horaires de travail et disponibilit√©s d'un membre du personnel**

    ## üéØ Fonctionnalit√©s

    ### üìä **Types de disponibilit√©s configurables**
    - **Horaires de travail** : Jours de la semaine avec cr√©neaux horaires
    - **Cong√©s** : P√©riodes d'indisponibilit√© avec raisons
    - **Horaires sp√©ciaux** : Horaires ponctuels pour dates sp√©cifiques

    ### üíº **Cas d'usage m√©tier**
    - Configuration des horaires r√©guliers (ex: Lun-Ven 9h-17h)
    - Gestion des vacances et cong√©s maladie
    - Horaires exceptionnels (formations, √©v√©nements)
    - Planification des cr√©neaux de r√©servation

    ### üîê **Permissions requises**
    - **MANAGE_STAFF** : Gestionnaires et administrateurs
    - **SELF_MANAGE** : Staff peut g√©rer ses propres disponibilit√©s

    ## üìù **Structure des donn√©es**

    \`\`\`json
    {
      "workingHours": [
        {
          "dayOfWeek": 1,
          "startTime": "09:00",
          "endTime": "17:00",
          "isWorkingDay": true
        }
      ],
      "timeOff": [
        {
          "startDate": "2024-12-20T00:00:00Z",
          "endDate": "2024-12-27T00:00:00Z",
          "reason": "Vacances de No√´l"
        }
      ],
      "specialSchedule": [
        {
          "date": "2024-12-31T00:00:00Z",
          "startTime": "10:00",
          "endTime": "14:00",
          "isAvailable": true
        }
      ]
    }
    \`\`\`
    `,
  })
  @ApiParam({
    name: 'id',
    description: 'Staff member UUID',
    example: '123e4567-e89b-12d3-a456-426614174000',
  })
  @ApiResponse({
    status: HttpStatus.OK,
    description: '‚úÖ Staff availability configured successfully',
  })
  @ApiResponse({
    status: HttpStatus.BAD_REQUEST,
    description: '‚ùå Invalid availability data',
  })
  @ApiResponse({
    status: HttpStatus.NOT_FOUND,
    description: '‚ùå Staff member not found',
  })
  @ApiResponse({
    status: HttpStatus.UNAUTHORIZED,
    description: 'üîê Authentication required',
  })
  @ApiResponse({
    status: HttpStatus.FORBIDDEN,
    description: 'üö´ Insufficient permissions',
  })
  async setStaffAvailability(
    @Param('id') id: string,
    @Body() dto: any, // TODO: Cr√©er SetStaffAvailabilityDto
    @GetUser() user: User,
  ): Promise<any> {
    return await this.setStaffAvailabilityUseCase.execute({
      staffId: id,
      workingHours: dto.workingHours || [],
      timeOff: dto.timeOff,
      specialSchedule: dto.specialSchedule,
      requestingUserId: user.id,
      correlationId: dto.correlationId,
    });
  }

  @Get(':id/availability')
  @ApiOperation({
    summary: 'üìã R√©cup√©rer les disponibilit√©s du staff',
    description: `
    **Obtient les horaires de travail et disponibilit√©s d'un membre du personnel**

    ## üéØ Informations retourn√©es

    ### üìä **Donn√©es compl√®tes**
    - **Horaires de travail** : Planning hebdomadaire complet
    - **Cong√©s programm√©s** : P√©riodes d'indisponibilit√©
    - **Horaires sp√©ciaux** : Cr√©neaux exceptionnels
    - **Statistiques** : Heures travaill√©es, disponibilit√© moyenne

    ### üí° **Utilisation**
    - Affichage du planning personnel
    - Calcul des cr√©neaux disponibles pour rendez-vous
    - Interface de gestion des horaires
    - Reporting RH sur la disponibilit√©

    ## üìà **M√©tadonn√©es incluses**
    - Derni√®re mise √† jour des disponibilit√©s
    - Nombre total d'heures configur√©es
    - P√©riodes de cong√©s actives
    - Conflits potentiels d√©tect√©s
    `,
  })
  @ApiParam({
    name: 'id',
    description: 'Staff member UUID',
    example: '123e4567-e89b-12d3-a456-426614174000',
  })
  @ApiResponse({
    status: HttpStatus.OK,
    description: '‚úÖ Staff availability retrieved successfully',
  })
  @ApiResponse({
    status: HttpStatus.NOT_FOUND,
    description: '‚ùå Staff member not found',
  })
  @ApiResponse({
    status: HttpStatus.UNAUTHORIZED,
    description: 'üîê Authentication required',
  })
  async getStaffAvailability(
    @Param('id') id: string,
    @GetUser() user: User,
  ): Promise<any> {
    return await this.getStaffAvailabilityUseCase.execute({
      staffId: id,
      requestingUserId: user.id,
    });
  }

  @Post('available')
  @HttpCode(HttpStatus.OK)
  @ApiOperation({
    summary: 'üîç Rechercher staff disponible',
    description: `
    **Trouve les membres du personnel disponibles selon des crit√®res**

    ## üéØ Fonctionnalit√©s de recherche

    ### üìÖ **Crit√®res temporels**
    - **Date et heure** : Cr√©neaux sp√©cifiques
    - **Dur√©e** : Blocs de temps requis
    - **R√©currence** : Disponibilit√© r√©p√©t√©e
    - **Plage horaire** : Recherche sur plusieurs jours

    ### üë• **Filtres personnel**
    - **Comp√©tences** : Skills techniques requises
    - **Services** : Types de prestations
    - **Localisation** : Proximit√© g√©ographique
    - **Exp√©rience** : Niveau d'expertise

    ### üéØ **Cas d'usage m√©tier**
    - Planification automatique de rendez-vous
    - R√©partition optimale des charges de travail
    - Gestion des remplacements en urgence
    - Optimisation des cr√©neaux horaires

    ## üìù **Exemple de requ√™te**

    \`\`\`json
    {
      "dateRange": {
        "startDate": "2024-01-15T00:00:00Z",
        "endDate": "2024-01-19T23:59:59Z"
      },
      "timeSlot": {
        "startTime": "14:00",
        "endTime": "16:00"
      },
      "skills": ["MASSAGE", "PHYSIOTHERAPY"],
      "businessId": "business-uuid",
      "minExperience": 2
    }
    \`\`\`

    ## üìä **R√©ponse enrichie**
    - Liste des staff disponibles avec d√©tails
    - Score de pertinence selon crit√®res
    - Cr√©neaux exacts de disponibilit√©
    - Informations de contact et localisation
    `,
  })
  @ApiResponse({
    status: HttpStatus.OK,
    description: '‚úÖ Available staff found successfully',
  })
  @ApiResponse({
    status: HttpStatus.BAD_REQUEST,
    description: '‚ùå Invalid search criteria',
  })
  @ApiResponse({
    status: HttpStatus.UNAUTHORIZED,
    description: 'üîê Authentication required',
  })
  async getAvailableStaff(
    @Body() dto: any, // TODO: Cr√©er GetAvailableStaffDto
    @GetUser() user: User,
  ): Promise<any> {
    return await this.getAvailableStaffUseCase.execute({
      businessId: dto.businessId,
      dateTime: new Date(dto.timeSlot), // Conversion timeSlot -> dateTime
      durationMinutes: 60, // Dur√©e par d√©faut
      serviceId: dto.serviceIds?.[0], // Premier serviceId si disponible
      requestingUserId: user.id,
      correlationId: dto.correlationId,
    });
  }
}
